name: Deploy ASP.NET Framework App to AWS EB

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: windows-latest 

    steps:
      # 1. Checkout Repository
      - name: Checkout Source Code
        uses: actions/checkout@v3

      # 2. Configure MSBuild
      - name: Setup MSBuild and Visual Studio Tools Path
        uses: microsoft/setup-msbuild@v2

      # 3. Restore NuGet Packages (Fixed with Change Directory)
      - name: Restore Project Dependencies
        run: |
          echo "Changing directory to FitnessProjectAfterUpdate\FitnessProjectAfterUpdate"
          # Change directory to the folder containing the .sln file
          cd FitnessProjectAfterUpdate\FitnessProjectAfterUpdate
          # Run restore command using only the filename
          nuget restore fitnessProject.sln

      # 4. Build and Publish Application (Fixed with Change Directory)
      - name: Publish ASP.NET Application for Deployment
        run: |
          echo "Changing directory to FitnessProjectAfterUpdate\FitnessProjectAfterUpdate"
          # Change directory to the folder containing the .csproj file
          cd FitnessProjectAfterUpdate\FitnessProjectAfterUpdate
          
          # Compiles and creates a deployable web package in the 'publish' directory.
          msbuild fitnessProject.csproj /p:Configuration=Release /p:DeployOnBuild=true /p:PublishProfile=Folder /p:PublishDir="${{ github.workspace }}\publish" /p:VisualStudioVersion=17.0
          
      # 5. Configure AWS Credentials
      - name: Set Up AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-north-1

      # 6. Install Elastic Beanstalk (EB) CLI
      - name: Install EB CLI Tool
        run: pip install --upgrade awsebcli

      # 7. Deploy Published Artifact to EB Environment
      - name: Deploy to Elastic Beanstalk
        run: |
          # The publish directory is relative to the *initial* workspace root (D:\a\...), so we navigate there
          cd ${{ github.workspace }}/publish
          
          # Initialize EB application metadata
          eb init fitnessProject --platform "64bit Windows Server 2025 v2.21.1 running IIS 10.0" --region eu-north-1
          
          # Target the specific environment
          eb use FitnessProject-env-1
          
          # Deploy the contents of the current directory
          eb deploy
